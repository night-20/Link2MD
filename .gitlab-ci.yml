---
image: node:22-alpine
stages:
- ".pre"
- install
- build
- deploy
- ".post"
cache:
  key:
    files:
    - package-lock.json
  paths:
  - node_modules/
  policy: pull-push
install_deps:
  stage: install
  script:
  - npm ci --prefer-offline
  artifacts:
    paths:
    - node_modules/
    expire_in: 1 hour
build_check:
  stage: build
  needs:
  - install_deps
  script:
  - npm run build
  artifacts:
    paths:
    - ".next/"
    - out/
    expire_in: 1 hour
pages:
  stage: deploy
  needs:
  - build_check
  script:
  - mkdir -p public
  - 'if [ -d "out" ]; then cp -r out/* public/; else echo "Error: out directory not
    found"; exit 1; fi'
  artifacts:
    paths:
    - public
  rules:
  - if: $CI_COMMIT_BRANCH == "main"
deploy_production:
  stage: deploy
  needs:
  - build_check
  script:
  - npm install -g vercel --no-fund --quiet
  - vercel pull --yes --environment=production --token=$VERCEL_TOKEN
  - vercel build --prod --token=$VERCEL_TOKEN
  - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
  environment:
    name: link2-md
    url: https://link2-md.vercel.app/
  rules:
  - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"
deploy_preview:
  stage: deploy
  needs:
  - build_check
  script:
  - npm install -g vercel --no-fund --quiet
  - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
  - vercel build --token=$VERCEL_TOKEN
  - vercel deploy --prebuilt --token=$VERCEL_TOKEN > deploy_url.txt
  - echo "预览地址：$(cat deploy_url.txt)"
  environment:
    name: preview/$CI_COMMIT_REF_SLUG
  rules:
  - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != "main"
